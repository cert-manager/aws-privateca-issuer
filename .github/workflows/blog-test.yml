name: blog-test

on:
  # Triggers the workflow on push or pull request events but only for the master branch
  pull_request_target:
    types: [labeled]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  start-runner:
    runs-on: ubuntu-latest
    outputs:
      label: ${{ steps.start-ec2-runner.outputs.label }}
      ec2-instance-id: ${{ steps.start-ec2-runner.outputs.ec2-instance-id }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          role-to-assume: arn:aws:iam::892721419421:role/GithubActionsTestingRole-dev-solonish-us-east-1
          aws-region: us-east-1
      - name: Configure EC2 Runner Parameters
        run: |
          AWS_REGION=us-east-1
          VPC_ID=$(aws ec2 describe-vpcs --filters 'Name=is-default,Values=true' --query 'Vpcs[0].VpcId' --output text)
          SUBNET_ID=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" --query 'Subnets[0].SubnetId' --output text)
          SG_ID=$(aws ec2 describe-security-groups --filters 'Name=group-name,Values=default' --query 'SecurityGroups[0].GroupId' --output text)
          AMI=$(aws ssm get-parameter --name /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2 --query 'Parameter.Value' --output text) 
          echo AWS_REGION=$AWS_REGION >> $GITHUB_ENV
          echo SUBNET_ID=$SUBNET_ID >> $GITHUB_ENV
          echo SG_ID=$SG_ID >> $GITHUB_ENV
          echo AMI=$AMI >> $GITHUB_ENV
      - name: Start EC2 runner
        id: start-ec2-runner
        uses: divyansh-gupta/ec2-github-runner@cc04b23befe52cc1f2e4e8ae8047d1c3b7dc40af
        with:
          mode: start
          github-token: GithubToken-dev-solonish-us-east-1
          ec2-image-id: ${{ env.AMI }}
          ec2-instance-type: t3.medium
          subnet-id: ${{ env.SUBNET_ID }}
          security-group-id: ${{ env.SG_ID }}
          iam-role-name: K8sPluginInstanceProfile-dev-solonish-us-east-1
          ec2-launch-template: GithubRunnerLaunchTemplate-dev-solonish-us-east-1
          aws-resource-tags: >
            [
              {"Key": "Name", "Value": "ec2-github-runner"},
              {"Key": "GitHubRepository", "Value": "${{ github.repository }}"}
            ]

  stop-runner:
    name: Stop self-hosted EC2 runner
    needs:
      - start-runner # required to get output from the start-runner job
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          role-to-assume: arn:aws:iam::892721419421:role/GithubActionsTestingRole-dev-solonish-us-east-1
          aws-region: us-east-1
      - name: Setup AWS Region
        run: |
          AWS_REGION=us-east-1
          echo AWS_REGION=$AWS_REGION >> $GITHUB_ENV
      - name: Stop EC2 runner
        uses: divyansh-gupta/ec2-github-runner@cc04b23befe52cc1f2e4e8ae8047d1c3b7dc40af
        with:
          mode: stop
          github-token: GithubToken-dev-solonish-us-east-1
          label: ${{ needs.start-runner.outputs.label }}
          ec2-instance-id: ${{ needs.start-runner.outputs.ec2-instance-id }}
